# Build uv binaries and publish to GHCR as OCI artifacts
#
# Generates binaries for all platforms and pushes them to GHCR as 
# immutable OCI artifacts with attestations.
#
# Called from:
# - .github/workflows/ci.yml (when release-relevant files change)
# - .github/workflows/release.yml (as a local artifacts job within `cargo-dist`)
name: "Build and publish binaries to GHCR"

on:
  workflow_call:
    inputs:
      plan:
        required: false
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PACKAGE_NAME: uv
  MODULE_NAME: uv
  PYTHON_VERSION: "3.11"
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  CARGO_TERM_COLOR: always
  RUSTUP_MAX_RETRIES: 10
  UV_GHCR_BINARIES: ghcr.io/${{ github.repository_owner }}/uv-binaries

permissions: {}

jobs:
  binary-plan:
    name: plan
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      login: ${{ steps.plan.outputs.login }}
      push: ${{ steps.plan.outputs.push }}
      tag: ${{ steps.plan.outputs.tag }}
      action: ${{ steps.plan.outputs.action }}
    steps:
      - name: Set push variable
        env:
          DRY_RUN: ${{ inputs.plan == '' || fromJson(inputs.plan).announcement_tag_is_implicit }}
          TAG: ${{ inputs.plan != '' && fromJson(inputs.plan).announcement_tag }}
          IS_LOCAL_PR: ${{ github.event.pull_request.head.repo.full_name == 'astral-sh/uv' }}
        id: plan
        run: |
          if [ "${DRY_RUN}" == "false" ]; then
            echo "login=true" >> "$GITHUB_OUTPUT"
            echo "push=true" >> "$GITHUB_OUTPUT"
            echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
            echo "action=build and publish" >> "$GITHUB_OUTPUT"
          else
            echo "login=${IS_LOCAL_PR}" >> "$GITHUB_OUTPUT"
            echo "push=false" >> "$GITHUB_OUTPUT"
            echo "tag=dry-run" >> "$GITHUB_OUTPUT"
            echo "action=build" >> "$GITHUB_OUTPUT"
          fi

  sdist:
    name: sdist
    if: ${{ !contains(github.event.pull_request.labels.*.name, 'no-build') }}
    runs-on: ubuntu-latest
    needs: binary-plan
    permissions:
      id-token: write
      contents: read
      attestations: write
      packages: write
    environment:
      name: ${{ needs.binary-plan.outputs.push == 'true' && 'release' || '' }}
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - uses: docker/login-action@v3
        if: ${{ needs.binary-plan.outputs.login == 'true' }}
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # uv sdist
      - name: "Prep README.md"
        run: python scripts/transform_readme.py --target pypi
      
      - name: "Build sdist"
        uses: PyO3/maturin-action@v1
        with:
          maturin-version: v1.9.6
          command: sdist
          args: --out dist
      
      - name: "Test sdist"
        run: |
          pip install dist/${PACKAGE_NAME}-*.tar.gz --force-reinstall
          ${MODULE_NAME} --help
          python -m ${MODULE_NAME} --help
          uvx --help

      - name: "Upload sdist to artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: wheels_uv-sdist
          path: dist

      # Push to GHCR
      - name: Install oras
        if: ${{ needs.binary-plan.outputs.push == 'true' }}
        run: |
          curl -LO https://github.com/oras-project/oras/releases/download/v1.1.0/oras_1.1.0_linux_amd64.tar.gz
          tar -xzf oras_1.1.0_linux_amd64.tar.gz oras
          chmod +x oras
          sudo mv oras /usr/local/bin/

      - name: "Push sdist to GHCR"
        if: ${{ needs.binary-plan.outputs.push == 'true' }}
        id: push-sdist
        run: |
          ARTIFACT_NAME="${PACKAGE_NAME}-sdist"
          DIGEST=$(oras push \
            "${UV_GHCR_BINARIES}/${ARTIFACT_NAME}:${{ needs.binary-plan.outputs.tag }}" \
            dist/${PACKAGE_NAME}-*.tar.gz:application/vnd.uv.sdist.v1.tar+gzip \
            --format json | jq -r '.digest')
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Pushed ${UV_GHCR_BINARIES}/${ARTIFACT_NAME}@$DIGEST"

      - name: "Attest sdist"
        if: ${{ needs.binary-plan.outputs.push == 'true' }}
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ${{ env.UV_GHCR_BINARIES }}/uv-sdist
          subject-digest: ${{ steps.push-sdist.outputs.digest }}

  macos-x86_64:
    name: x86_64-apple-darwin
    if: ${{ !contains(github.event.pull_request.labels.*.name, 'no-build') }}
    runs-on: depot-macos-14
    needs: binary-plan
    permissions:
      id-token: write
      contents: read
      attestations: write
      packages: write
    environment:
      name: ${{ needs.binary-plan.outputs.push == 'true' && 'release' || '' }}
    env:
      TARGET: x86_64-apple-darwin
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - uses: docker/login-action@v3
        if: ${{ needs.binary-plan.outputs.login == 'true' }}
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: x64

      - name: "Prep README.md"
        run: python scripts/transform_readme.py --target pypi

      # Build wheels
      - name: "Build wheels - x86_64"
        uses: PyO3/maturin-action@v1
        with:
          maturin-version: v1.9.6
          target: x86_64
          args: --release --locked --out dist --features self-update

      - name: "Upload wheels"
        uses: actions/upload-artifact@v4
        with:
          name: wheels_uv-macos-x86_64
          path: dist

      # Build and archive binary
      - name: "Archive binary"
        run: |
          ARCHIVE_NAME=uv-$TARGET
          ARCHIVE_FILE=$ARCHIVE_NAME.tar.gz

          mkdir -p $ARCHIVE_NAME
          cp target/$TARGET/release/uv $ARCHIVE_NAME/uv
          cp target/$TARGET/release/uvx $ARCHIVE_NAME/uvx
          tar czvf $ARCHIVE_FILE $ARCHIVE_NAME
          shasum -a 256 $ARCHIVE_FILE > $ARCHIVE_FILE.sha256

      - name: "Upload binary to artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ env.TARGET }}
          path: |
            *.tar.gz
            *.sha256

      # Push to GHCR
      - name: Install oras
        if: ${{ needs.binary-plan.outputs.push == 'true' }}
        run: |
          curl -LO https://github.com/oras-project/oras/releases/download/v1.1.0/oras_1.1.0_darwin_amd64.tar.gz
          tar -xzf oras_1.1.0_darwin_amd64.tar.gz oras
          chmod +x oras
          sudo mv oras /usr/local/bin/

      - name: "Push binary to GHCR"
        if: ${{ needs.binary-plan.outputs.push == 'true' }}
        id: push-binary
        run: |
          ARCHIVE_FILE=uv-$TARGET.tar.gz
          DIGEST=$(oras push \
            "${UV_GHCR_BINARIES}/uv-${TARGET}:${{ needs.binary-plan.outputs.tag }}" \
            $ARCHIVE_FILE:application/vnd.uv.binary.v1.tar+gzip \
            uv-$TARGET.tar.gz.sha256:text/plain \
            --format json | jq -r '.digest')
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Pushed ${UV_GHCR_BINARIES}/uv-${TARGET}@$DIGEST"

      - name: "Attest GHCR binary"
        if: ${{ needs.binary-plan.outputs.push == 'true' }}
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ${{ env.UV_GHCR_BINARIES }}/uv-${{ env.TARGET }}
          subject-digest: ${{ steps.push-binary.outputs.digest }}

  macos-aarch64:
    name: aarch64-apple-darwin
    if: ${{ !contains(github.event.pull_request.labels.*.name, 'no-build') }}
    runs-on: depot-macos-14
    needs: binary-plan
    permissions:
      id-token: write
      contents: read
      attestations: write
      packages: write
    environment:
      name: ${{ needs.binary-plan.outputs.push == 'true' && 'release' || '' }}
    env:
      TARGET: aarch64-apple-darwin
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - uses: docker/login-action@v3
        if: ${{ needs.binary-plan.outputs.login == 'true' }}
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: arm64

      - name: "Prep README.md"
        run: python scripts/transform_readme.py --target pypi

      - name: "Build wheels - aarch64"
        uses: PyO3/maturin-action@v1
        with:
          maturin-version: v1.9.6
          target: aarch64
          args: --release --locked --out dist --features self-update

      - name: "Test wheel - aarch64"
        run: |
          pip install ${PACKAGE_NAME} --no-index --find-links dist/ --force-reinstall
          ${MODULE_NAME} --help
          python -m ${MODULE_NAME} --help
          uvx --help

      - name: "Upload wheels"
        uses: actions/upload-artifact@v4
        with:
          name: wheels_uv-aarch64-apple-darwin
          path: dist

      - name: "Archive binary"
        run: |
          ARCHIVE_NAME=uv-$TARGET
          ARCHIVE_FILE=$ARCHIVE_NAME.tar.gz

          mkdir -p $ARCHIVE_NAME
          cp target/$TARGET/release/uv $ARCHIVE_NAME/uv
          cp target/$TARGET/release/uvx $ARCHIVE_NAME/uvx
          tar czvf $ARCHIVE_FILE $ARCHIVE_NAME
          shasum -a 256 $ARCHIVE_FILE > $ARCHIVE_FILE.sha256

      - name: "Upload binary to artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ env.TARGET }}
          path: |
            *.tar.gz
            *.sha256

      - name: Install oras
        if: ${{ needs.binary-plan.outputs.push == 'true' }}
        run: |
          curl -LO https://github.com/oras-project/oras/releases/download/v1.1.0/oras_1.1.0_darwin_arm64.tar.gz
          tar -xzf oras_1.1.0_darwin_arm64.tar.gz oras
          chmod +x oras
          sudo mv oras /usr/local/bin/

      - name: "Push binary to GHCR"
        if: ${{ needs.binary-plan.outputs.push == 'true' }}
        id: push-binary
        run: |
          ARCHIVE_FILE=uv-$TARGET.tar.gz
          DIGEST=$(oras push \
            "${UV_GHCR_BINARIES}/uv-${TARGET}:${{ needs.binary-plan.outputs.tag }}" \
            $ARCHIVE_FILE:application/vnd.uv.binary.v1.tar+gzip \
            uv-$TARGET.tar.gz.sha256:text/plain \
            --format json | jq -r '.digest')
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Pushed ${UV_GHCR_BINARIES}/uv-${TARGET}@$DIGEST"

      - name: "Attest GHCR binary"
        if: ${{ needs.binary-plan.outputs.push == 'true' }}
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ${{ env.UV_GHCR_BINARIES }}/uv-${{ env.TARGET }}
          subject-digest: ${{ steps.push-binary.outputs.digest }}

  windows:
    name: ${{ matrix.platform.target }}
    if: ${{ !contains(github.event.pull_request.labels.*.name, 'no-build') }}
    runs-on: github-windows-2022-x86_64-8
    needs: binary-plan
    permissions:
      id-token: write
      contents: read
      attestations: write
      packages: write
    environment:
      name: ${{ needs.binary-plan.outputs.push == 'true' && 'release' || '' }}
    strategy:
      matrix:
        platform:
          - target: x86_64-pc-windows-msvc
            arch: x64
          - target: i686-pc-windows-msvc
            arch: x86
          - target: aarch64-pc-windows-msvc
            arch: x64
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - uses: docker/login-action@v3
        if: ${{ needs.binary-plan.outputs.login == 'true' }}
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: ${{ matrix.platform.arch }}

      - name: "Prep README.md"
        run: python scripts/transform_readme.py --target pypi

      - name: "Build wheels"
        uses: PyO3/maturin-action@v1
        with:
          maturin-version: v1.9.6
          target: ${{ matrix.platform.target }}
          args: --release --locked --out dist --features self-update,windows-gui-bin

      - name: "Test wheel"
        if: ${{ !startsWith(matrix.platform.target, 'aarch64') }}
        shell: bash
        run: |
          pip install ${PACKAGE_NAME} --no-index --find-links dist/ --force-reinstall
          ${MODULE_NAME} --help
          python -m ${MODULE_NAME} --help
          uvx --help
          uvw --help

      - name: "Upload wheels"
        uses: actions/upload-artifact@v4
        with:
          name: wheels_uv-${{ matrix.platform.target }}
          path: dist

      - name: "Archive binary"
        shell: bash
        run: |
          ARCHIVE_FILE=uv-${PLATFORM_TARGET}.zip
          7z a $ARCHIVE_FILE ./target/${PLATFORM_TARGET}/release/uv.exe
          7z a $ARCHIVE_FILE ./target/${PLATFORM_TARGET}/release/uvx.exe
          7z a $ARCHIVE_FILE ./target/${PLATFORM_TARGET}/release/uvw.exe
          sha256sum $ARCHIVE_FILE > $ARCHIVE_FILE.sha256
        env:
          PLATFORM_TARGET: ${{ matrix.platform.target }}

      - name: "Upload binary to artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.platform.target }}
          path: |
            *.zip
            *.sha256

      - name: Install oras
        if: ${{ needs.binary-plan.outputs.push == 'true' }}
        shell: bash
        run: |
          curl -LO https://github.com/oras-project/oras/releases/download/v1.1.0/oras_1.1.0_windows_amd64.zip
          unzip oras_1.1.0_windows_amd64.zip oras.exe
          mv oras.exe /c/Windows/System32/

      - name: "Push binary to GHCR"
        if: ${{ needs.binary-plan.outputs.push == 'true' }}
        shell: bash
        id: push-binary
        env:
          PLATFORM_TARGET: ${{ matrix.platform.target }}
        run: |
          ARCHIVE_FILE=uv-${PLATFORM_TARGET}.zip
          DIGEST=$(oras push \
            "${UV_GHCR_BINARIES}/uv-${PLATFORM_TARGET}:${{ needs.binary-plan.outputs.tag }}" \
            $ARCHIVE_FILE:application/zip \
            uv-${PLATFORM_TARGET}.zip.sha256:text/plain \
            --format json | jq -r '.digest')
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Pushed ${UV_GHCR_BINARIES}/uv-${PLATFORM_TARGET}@$DIGEST"

      - name: "Attest GHCR binary"
        if: ${{ needs.binary-plan.outputs.push == 'true' }}
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ${{ env.UV_GHCR_BINARIES }}/uv-${{ matrix.platform.target }}
          subject-digest: ${{ steps.push-binary.outputs.digest }}

  linux:
    name: ${{ matrix.target }}
    if: ${{ !contains(github.event.pull_request.labels.*.name, 'no-build') }}
    runs-on: depot-ubuntu-latest-4
    needs: binary-plan
    permissions:
      id-token: write
      contents: read
      attestations: write
      packages: write
    environment:
      name: ${{ needs.binary-plan.outputs.push == 'true' && 'release' || '' }}
    strategy:
      matrix:
        include:
          - { target: "i686-unknown-linux-gnu", cc: "gcc -m32" }
          - { target: "x86_64-unknown-linux-gnu", cc: "gcc" }
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - uses: docker/login-action@v3
        if: ${{ needs.binary-plan.outputs.login == 'true' }}
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: x64

      - name: "Prep README.md"
        run: python scripts/transform_readme.py --target pypi

      - name: "Build wheels"
        uses: PyO3/maturin-action@v1
        with:
          maturin-version: v1.9.6
          target: ${{ matrix.target }}
          container: quay.io/pypa/manylinux2014
          manylinux: auto
          args: --release --locked --out dist --features self-update
          before-script-linux: |
            rustup target add ${{ matrix.target }}
            if command -v yum &> /dev/null; then
                yum update -y && yum install -y perl-core openssl openssl-devel pkgconfig libatomic
                if [[ ! -d "/usr/lib64" ]]; then
                    ln -s /usr/lib/libatomic.so.1 /usr/lib/libatomic.so
                else
                    yum install -y glibc-devel.i686 libstdc++-devel.i686
                fi
            else
                apt update -y && apt-get install -y libssl-dev openssl pkg-config
            fi
        env:
          CC: ${{ matrix.cc }}

      - name: "Test wheel"
        if: ${{ startsWith(matrix.target, 'x86_64') }}
        run: |
          pip install ${PACKAGE_NAME} --no-index --find-links dist/ --force-reinstall
          ${MODULE_NAME} --help
          python -m ${MODULE_NAME} --help
          uvx --help

      - name: "Upload wheels"
        uses: actions/upload-artifact@v4
        with:
          name: wheels_uv-${{ matrix.target }}
          path: dist

      - name: "Archive binary"
        shell: bash
        run: |
          ARCHIVE_NAME=uv-$TARGET
          ARCHIVE_FILE=$ARCHIVE_NAME.tar.gz

          mkdir -p $ARCHIVE_NAME
          cp target/$TARGET/release/uv $ARCHIVE_NAME/uv
          cp target/$TARGET/release/uvx $ARCHIVE_NAME/uvx
          tar czvf $ARCHIVE_FILE $ARCHIVE_NAME
          shasum -a 256 $ARCHIVE_FILE > $ARCHIVE_FILE.sha256
        env:
          TARGET: ${{ matrix.target }}

      - name: "Upload binary to artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.target }}
          path: |
            *.tar.gz
            *.sha256

      - name: Install oras
        if: ${{ needs.binary-plan.outputs.push == 'true' }}
        run: |
          curl -LO https://github.com/oras-project/oras/releases/download/v1.1.0/oras_1.1.0_linux_amd64.tar.gz
          tar -xzf oras_1.1.0_linux_amd64.tar.gz oras
          chmod +x oras
          sudo mv oras /usr/local/bin/

      - name: "Push binary to GHCR"
        if: ${{ needs.binary-plan.outputs.push == 'true' }}
        id: push-binary
        env:
          TARGET: ${{ matrix.target }}
        run: |
          ARCHIVE_FILE=uv-$TARGET.tar.gz
          DIGEST=$(oras push \
            "${UV_GHCR_BINARIES}/uv-${TARGET}:${{ needs.binary-plan.outputs.tag }}" \
            $ARCHIVE_FILE:application/vnd.uv.binary.v1.tar+gzip \
            uv-$TARGET.tar.gz.sha256:text/plain \
            --format json | jq -r '.digest')
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Pushed ${UV_GHCR_BINARIES}/uv-${TARGET}@$DIGEST"

      - name: "Attest GHCR binary"
        if: ${{ needs.binary-plan.outputs.push == 'true' }}
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ${{ env.UV_GHCR_BINARIES }}/uv-${{ matrix.target }}
          subject-digest: ${{ steps.push-binary.outputs.digest }}
